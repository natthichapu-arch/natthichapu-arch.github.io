<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Interactive Chat Prototype</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #chatBox { border: 1px solid #ccc; height: 300px; width: 400px; overflow-y: auto; padding: 10px; }
  .message { padding: 5px; margin: 5px 0; border-radius: 5px; }
  .userA { background-color: #d1e7dd; text-align: left; }
  .userB { background-color: #f8d7da; text-align: right; }
</style>
</head>
<body>

<h2>Chat Prototype</h2>

<div>
  <label>Select User: </label>
  <select id="userSelect">
    <option value="A">User A</option>
    <option value="B">User B</option>
  </select>
</div>

<div id="chatBox"></div>

<input type="text" id="messageInput" placeholder="พิมพ์ข้อความ..." />
<button onclick="sendMessage()">Send</button>

<script>
  const chatBox = document.getElementById('chatBox');

  // ดึงข้อความจาก LocalStorage
  function loadMessages() {
    const messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
    chatBox.innerHTML = '';
    messages.forEach(msg => addMessageToDOM(msg.user, msg.text, msg.timestamp));
  }

  // เพิ่มข้อความลง DOM
  function addMessageToDOM(user, text, timestamp) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', user === 'A' ? 'userA' : 'userB');
    msgDiv.textContent = `${text} (${new Date(timestamp).toLocaleTimeString()})`;
    chatBox.appendChild(msgDiv);

    // ตั้งเวลาให้ข้อความหายไป 20 วินาที
    setTimeout(() => {
      msgDiv.remove();
      removeMessageFromStorage(timestamp);
    }, 20000);
  }

  // ลบข้อความจาก LocalStorage
  function removeMessageFromStorage(timestamp) {
    let messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
    messages = messages.filter(msg => msg.timestamp !== timestamp);
    localStorage.setItem('chatMessages', JSON.stringify(messages));
  }

  // ส่งข้อความ
  function sendMessage() {
    const user = document.getElementById('userSelect').value;
    const text = document.getElementById('messageInput').value.trim();
    if (!text) return;

    const timestamp = Date.now();
    addMessageToDOM(user, text, timestamp);

    // เก็บข้อความลง LocalStorage
    const messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
    messages.push({ user, text, timestamp });
    localStorage.setItem('chatMessages', JSON.stringify(messages));

    document.getElementById('messageInput').value = '';
  }

  // โหลดข้อความตอนเริ่มต้น
  loadMessages();

  // ตรวจจับการเปลี่ยนแปลง LocalStorage จากแท็บอื่น (จำลองเรียลไทม์)
  window.addEventListener('storage', loadMessages);
</script>

</body>
</html>
